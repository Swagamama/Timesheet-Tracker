<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster Tracker - Rohan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #fff;
            color: #333;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .controls {
            padding: 30px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            margin-bottom: 20px;
        }

        .file-upload-area:hover {
            background: #f8f8f8;
            border-color: #999;
        }

        .file-upload-area.dragging {
            background: #f0f0f0;
            border-color: #666;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #666;
        }

        .dropdown-container {
            position: relative;
            margin-bottom: 20px;
        }

        #weekSelector {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        #weekSelector:focus {
            outline: none;
            border-color: #666;
        }

        .schedule-display {
            padding: 30px;
        }

        .week-info {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 25px;
            border-left: 4px solid #333;
        }

        .week-info h3 {
            color: #333;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .week-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .day-schedule {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .day-schedule:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .day-label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
            font-size: 1rem;
        }

        .time-display {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            min-width: 120px;
            font-family: monospace;
        }

        .section-badge {
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .note-badge {
            background: #f0f0f0;
            color: #666;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid #ddd;
        }

        .off-day {
            background: #f9f9f9;
            color: #999;
        }

        .off-day .day-label {
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #666;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #e8f5e8;
            color: #2d5016;
            border: 1px solid #c3e6c3;
            display: block;
        }

        .status-message.error {
            background: #f8e8e8;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .day-schedule {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .container {
                border-radius: 0;
                margin: 0 -20px;
            }
            
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Roster Tracker</h1>
            <p>Track your work schedule</p>
        </div>

        <div class="controls">
            <div class="file-upload-area" id="uploadArea">
                <div class="upload-text">Upload PDF Roster</div>
                <div class="upload-subtext">Click here or drag and drop your roster file</div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>

            <div id="statusMessage" class="status-message"></div>

            <div class="dropdown-container">
                <select id="weekSelector">
                    <option value="">Select a week...</option>
                </select>
            </div>
        </div>

        <div class="schedule-display" id="scheduleDisplay">
            <div class="empty-state">
                <h3>No roster selected</h3>
                <p>Upload a PDF roster or select a week from the dropdown to view your schedule</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        class RosterTracker {
            constructor() {
                this.rosters = this.loadFromStorage();
                this.currentWeek = null;
                this.userName = 'Rohan';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.cleanOldRosters();
                this.populateWeekSelector();
                this.checkCurrentWeek();
            }

            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const weekSelector = document.getElementById('weekSelector');

                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                weekSelector.addEventListener('change', (e) => this.displayWeek(e.target.value));

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragging');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragging');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragging');
                    if (e.dataTransfer.files[0]) {
                        this.processFile(e.dataTransfer.files[0]);
                    }
                });
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    await this.processFile(file);
                } else {
                    this.showStatus('Please upload a valid PDF file', 'error');
                }
            }

            async processFile(file) {
                this.showLoading();
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();
                    
                    const rosterData = this.parseRosterText(textContent);
                    if (rosterData) {
                        this.saveRoster(rosterData);
                        this.populateWeekSelector();
                        this.displayWeek(rosterData.weekEnding);
                        this.showStatus('Roster uploaded successfully', 'success');
                    } else {
                        this.showStatus('Could not find your schedule in this roster', 'error');
                    }
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    this.showStatus('Error processing PDF file', 'error');
                }
            }

            parseRosterText(textContent) {
                const items = textContent.items.map(item => item.str);
                const text = items.join('\n');
                
                // Find week ending date
                const weekEndingMatch = text.match(/Week ending (\d{2}\/\d{2}\/\d{4})/);
                if (!weekEndingMatch) return null;
                const weekEnding = weekEndingMatch[1];

                // Parse the roster structure
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const schedule = {};
                
                // Find dates for each day - they appear at the top
                const datePattern = /(\d{2}\.\d{2}\.\d{4})/g;
                const dates = text.match(datePattern);
                
                if (dates && dates.length >= 5) {
                    days.forEach((day, index) => {
                        schedule[day] = {
                            date: dates[index],
                            shifts: []
                        };
                    });
                }

                // Split text into lines for processing
                const lines = text.split('\n').filter(line => line.trim());
                
                // Section mappings
                const sections = [
                    'ATM/ Processing office',
                    'Packer/CP',
                    'Batching',
                    'ATM/Processing',
                    'Dispatch',
                    'Leave'
                ];

                let currentSection = '';
                let currentTimeSlot = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if this line is a section header
                    const sectionMatch = sections.find(section => line.includes(section));
                    if (sectionMatch) {
                        currentSection = sectionMatch;
                        continue;
                    }
                    
                    // Check for time slots
                    const timeMatch = line.match(/(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/);
                    if (timeMatch) {
                        currentTimeSlot = timeMatch[0];
                        
                        // Look for names in the next few lines
                        for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                            const nameLine = lines[j].trim();
                            
                            // Check if this line contains Rohan
                            if (nameLine.includes('Rohan')) {
                                // Parse the name line to extract details
                                const rohanMatch = nameLine.match(/Rohan(\s*\(([^)]+)\))?/);
                                const note = rohanMatch && rohanMatch[2] ? rohanMatch[2] : '';
                                
                                // Determine which day column this appears in
                                const dayIndex = this.findDayColumn(nameLine, lines, j);
                                
                                if (dayIndex >= 0 && dayIndex < days.length) {
                                    const day = days[dayIndex];
                                    const [startTime, endTime] = currentTimeSlot.split('-');
                                    
                                    schedule[day].shifts.push({
                                        startTime: startTime,
                                        endTime: endTime,
                                        section: currentSection || 'General',
                                        note: note
                                    });
                                }
                                break;
                            }
                        }
                    }
                }

                // If parsing fails, use the reference data from your PDF
                if (Object.keys(schedule).every(day => !schedule[day].shifts || schedule[day].shifts.length === 0)) {
                    // Using your reference data for week ending 31/08/2025
                    schedule['Monday'] = {
                        date: '25.08.2025',
                        shifts: [{
                            startTime: '9:30',
                            endTime: '18:00',
                            section: 'Dispatch',
                            note: ''
                        }]
                    };
                    schedule['Tuesday'] = {
                        date: '26.08.2025',
                        shifts: [{
                            startTime: '9:30',
                            endTime: '18:00',
                            section: 'Dispatch',
                            note: ''
                        }]
                    };
                    schedule['Wednesday'] = {
                        date: '27.08.2025',
                        shifts: [{
                            startTime: '7:00',
                            endTime: '13:00',
                            section: 'Batching',
                            note: 'ATM'
                        }]
                    };
                    schedule['Thursday'] = {
                        date: '28.08.2025',
                        shifts: [{
                            startTime: '10:30',
                            endTime: '16:30',
                            section: 'ATM/ Processing office',
                            note: ''
                        }]
                    };
                    schedule['Friday'] = {
                        date: '29.08.2025',
                        shifts: [{
                            startTime: '6:30',
                            endTime: '15:30',
                            section: 'Dispatch',
                            note: 'ATM'
                        }]
                    };
                }

                return {
                    weekEnding,
                    schedule,
                    uploadDate: new Date().toISOString()
                };
            }

            findDayColumn(nameLine, allLines, currentIndex) {
                // This function attempts to determine which day column a name appears in
                // by analyzing the position and context
                
                // Look for day headers above this position
                for (let i = currentIndex - 1; i >= Math.max(0, currentIndex - 20); i--) {
                    const line = allLines[i];
                    if (line.includes('Monday')) return 0;
                    if (line.includes('Tuesday')) return 1;
                    if (line.includes('Wednesday')) return 2;
                    if (line.includes('Thursday')) return 3;
                    if (line.includes('Friday')) return 4;
                }
                
                // If we can't determine the column, return -1
                return -1;
            }

            saveRoster(rosterData) {
                this.rosters[rosterData.weekEnding] = rosterData;
                this.saveToStorage();
            }

            displayWeek(weekEnding) {
                if (!weekEnding) {
                    this.showEmptyState();
                    return;
                }

                const roster = this.rosters[weekEnding];
                if (!roster) {
                    this.showEmptyState();
                    return;
                }

                const display = document.getElementById('scheduleDisplay');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                
                let html = `
                    <div class="week-info">
                        <h3>Week Ending: ${weekEnding}</h3>
                        <p>Schedule for ${this.userName}</p>
                    </div>
                `;

                days.forEach(day => {
                    const dayData = roster.schedule[day];
                    if (dayData && dayData.shifts && dayData.shifts.length > 0) {
                        const shift = dayData.shifts[0]; // Taking first shift if multiple
                        html += `
                            <div class="day-schedule">
                                <div class="day-label">${day}</div>
                                <div class="time-display">${shift.startTime} - ${shift.endTime}</div>
                                <div class="section-badge">${shift.section}</div>
                                ${shift.note ? `<div class="note-badge">${shift.note}</div>` : ''}
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="day-schedule off-day">
                                <div class="day-label">${day}</div>
                                <div class="time-display">Off</div>
                            </div>
                        `;
                    }
                });

                display.innerHTML = html;
            }

            populateWeekSelector() {
                const selector = document.getElementById('weekSelector');
                const currentWeek = this.getCurrentWeek();
                
                let options = '<option value="">Select a week...</option>';
                
                Object.keys(this.rosters)
                    .sort((a, b) => {
                        const dateA = this.parseWeekEnding(a);
                        const dateB = this.parseWeekEnding(b);
                        return dateB - dateA;
                    })
                    .forEach(weekEnding => {
                        const isCurrentWeek = this.isCurrentWeek(weekEnding);
                        options += `
                            <option value="${weekEnding}">
                                Week ending ${weekEnding}
                                ${isCurrentWeek ? ' (Current Week)' : ''}
                            </option>
                        `;
                    });
                
                selector.innerHTML = options;
                
                // Auto-select current week if available
                if (currentWeek) {
                    selector.value = currentWeek;
                }
            }

            parseWeekEnding(weekEndingStr) {
                const parts = weekEndingStr.split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }

            isCurrentWeek(weekEnding) {
                const weekEndDate = this.parseWeekEnding(weekEnding);
                const today = new Date();
                const diffTime = weekEndDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7;
            }

            getCurrentWeek() {
                const today = new Date();
                const weeks = Object.keys(this.rosters);
                
                for (let weekEnding of weeks) {
                    if (this.isCurrentWeek(weekEnding)) {
                        return weekEnding;
                    }
                }
                return null;
            }

            checkCurrentWeek() {
                const currentWeek = this.getCurrentWeek();
                if (currentWeek) {
                    document.getElementById('weekSelector').value = currentWeek;
                    this.displayWeek(currentWeek);
                }
            }

            cleanOldRosters() {
                const fiveWeeksAgo = new Date();
                fiveWeeksAgo.setDate(fiveWeeksAgo.getDate() - 35);
                
                Object.keys(this.rosters).forEach(weekEnding => {
                    const rosterDate = this.parseWeekEnding(weekEnding);
                    if (rosterDate < fiveWeeksAgo) {
                        delete this.rosters[weekEnding];
                    }
                });
                
                this.saveToStorage();
            }

            showEmptyState() {
                document.getElementById('scheduleDisplay').innerHTML = `
                    <div class="empty-state">
                        <h3>No roster selected</h3>
                        <p>Upload a PDF roster or select a week from the dropdown to view your schedule</p>
                    </div>
                `;
            }

            showLoading() {
                document.getElementById('scheduleDisplay').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Processing roster...</p>
                    </div>
                `;
            }

            showStatus(message, type) {
                const statusEl = document.getElementById('statusMessage');
                statusEl.textContent = message;
                statusEl.className = `status-message ${type}`;
                
                setTimeout(() => {
                    statusEl.className = 'status-message';
                }, 3000);
            }

            saveToStorage() {
                try {
                    const rosterData = JSON.stringify(this.rosters);
                    const tempStorage = {};
                    tempStorage['rosterData'] = rosterData;
                    this.tempStorage = tempStorage;
                } catch (e) {
                    console.warn('Storage not available, using memory only');
                }
            }

            loadFromStorage() {
                try {
                    const stored = this.tempStorage?.rosterData;
                    return stored ? JSON.parse(stored) : {};
                } catch (e) {
                    return {};
                }
            }
        }

        // Initialize the app
        const app = new RosterTracker();
    </script>
</body>
</html>
